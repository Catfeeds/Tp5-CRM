{include file='layout/header'}
<div class="col-sm-12">
    <div class="ibox float-e-margins">
        <div class="ibox-title">
            <h5>销售记录</h5>
            <div class="ibox-tools">
                <a class="collapse-link">
                    <i class="fa fa-chevron-up"></i>
                </a>
                <a class="dropdown-toggle" data-toggle="dropdown" href="table_data_tables.html#">
                    <i class="fa fa-wrench"></i>
                </a>
                <ul class="dropdown-menu dropdown-user">
                    <li><a href="table_data_tables.html#">选项1</a>
                    </li>
                    <li><a href="table_data_tables.html#">选项2</a>
                    </li>
                </ul>
                <a class="close-link">
                    <i class="fa fa-times"></i>
                </a>
            </div>
        </div>
        <div class="ibox-content">

            <!--成功-->
            <div class="modal " tabindex="-1"  id="ok" data-backdrop="static" >
                <div class="modal-dialog" style="width: 180px;">
                    <!-- 内容声明 -->
                    <div class="modal-content">
                        <!-- 头部 -->
                        <!-- 主体 -->
                        <div class="modal-body">
                            <img src="__IMG__/loading.gif" alt="" style="margin-left: -20px;" id="ok-img" > <span id="ok-text">&nbsp;&nbsp;数据交互中...</span>
                        </div>
                        <!-- 注脚 -->

                    </div>
                </div>
            </div>
            <!--add-->
            <div class="modal " tabindex="-1"  id="myModal" data-backdrop="static" >
                <div class="modal-dialog"  style="width: 750px;">
                    <!-- 内容声明 -->
                    <div class="modal-content">
                        <!-- 头部 -->
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">
                                <span>&times;</span>
                            </button>
                            <h4 class="modal-title"> <span class="glyphicon glyphicon-plus"> 创建订单</span>  </h4>
                        </div>
                        <!-- 主体 -->
                        <div class="modal-body" style="overflow: auto; height: 550px;">
                            <div class="form-horizontal">

                                <div class="form-group">
                                    <label class="control-label">订单标题</label>
                                    <input type="text" class="form-control "  id="title" >
                                </div>

                                <div class="form-group">
                                    <label class=" control-label">关联跟单</label>
                                    <div class=" input-group">
                                        <input type="text" class="form-control "  id="client_company"  readonly style="background-color: white"  >
                                        <div class="input-group-addon" id="test"><span class="glyphicon glyphicon-search"></span></div>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class=" control-label">订单产品&nbsp;&nbsp;&nbsp;
                                        <a id="add"><span class="glyphicon glyphicon-plus"></span> 添加</a> &nbsp;&nbsp;
                                    </label>

                                    <div style="margin-top: 10px;">
                                        <table class="table table-hover table-bordered">
                                            <thead>
                                            <tr class="success" >
                                                <th  class="text-center">产品编号</th>
                                                <th  class="text-center">产品名称</th>
                                                <th  class="text-center">计量单位</th>
                                                <th  class="text-center">出售价</th>
                                                <th  class="text-center">数量</th>
                                                <th  class="text-center">操作</th>
                                            </tr>
                                            </thead>
                                            <tbody class="text-center" id="documentary_ok">

                                            </tbody>
                                        </table>
                                    </div>

                                </div>

                                <div class="form-group">
                                    <label class="control-label"  >订单价格：￥ <span id="q">0.00</span>  </label>

                                </div>

                                <div class="form-group">
                                    <label class=" control-label">订单金额</label>
                                    <div class=" input-group">
                                        <div class="input-group-addon" ><span class="glyphicon glyphicon-yen"></span></div>
                                        <input type="text" class="form-control "    id="x"   >
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label class="control-label">订单备注</label>
                                    <textarea type="text" class="form-control "  placeholder="255字以内备注说明"  style="min-height: 120px;" id="remarks" ></textarea>
                                </div>


                            </div>
                        </div>
                        <!-- 注脚 -->
                        <div class="modal-footer">
                            <a   class="btn btn-primary"  id="submit" > <span class="glyphicon glyphicon-ok">保存</span>  </a>
                            <a  class="btn btn-danger" style="margin-top: -5px;" data-dismiss="modal" > <span class="glyphicon glyphicon-remove">取消</span></a>
                        </div>
                    </div>
                </div>
            </div>

            <!--Product name-->
            <div class="modal" tabindex="-1"  id="product_name" data-backdrop="static" >
                <div class="modal-dialog">
                    <!-- 内容声明 -->
                    <div class="modal-content"  style="width: 750px;">
                        <!-- 头部 -->
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">
                                <span>&times;</span>
                            </button>
                            <h4 class="modal-title"> <span class="glyphicon glyphicon-plus"> 选择跟单</span>  </h4>
                        </div>
                        <!-- 主体 -->
                        <div class="modal-body" style="overflow: auto;max-height: 550px;" >
                            <div class="form-horizontal">
                                <table class="table table-hover table-bordered">
                                    <thead>
                                    <tr >
                                        <th></th>
                                        <th  class="text-center">跟单编号</th>
                                        <th  class="text-center">跟单标题</th>
                                        <th  class="text-center">所属公司</th>
                                        <th  class="text-center">跟单员</th>
                                        <th  class="text-center">选择跟单</th>
                                    </tr>
                                    </thead>
                                    <tbody class="text-center" id="product_ok">
                                    {volist name='documentary' id='value'}
                                    <tr>
                                        <td>{$value.id}</td>
                                        <td>{$value.sn}</td>
                                        <td>{$value.title}</td>
                                        <td>{$value.client_company}</td>
                                        <td>{$value.staff_name}</td>
                                        <td  class="documentary"><span class="glyphicon glyphicon-ok"> 选择</span></td>
                                    </tr>
                                    {/volist}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- 注脚 -->
                    </div>
                </div>
            </div>


            <div class="modal" tabindex="-1"  id="product" data-backdrop="static" >
                <div class="modal-dialog">
                    <!-- 内容声明 -->
                    <div class="modal-content"  style="width: 750px;">
                        <!-- 头部 -->
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">
                                <span>&times;</span>
                            </button>
                            <h4 class="modal-title"> <span class="glyphicon glyphicon-plus"> 选择产品</span>  </h4>
                        </div>
                        <!-- 主体 -->
                        <div class="modal-body" style="overflow: auto;max-height: 550px;" >
                            <div class="form-horizontal">
                                <table class="table table-hover table-bordered">
                                    <thead>
                                    <tr >
                                        <th></th>
                                        <th  class="text-center">产品编号</th>
                                        <th  class="text-center">产品名称</th>
                                        <th  class="text-center">计量单位</th>
                                        <th  class="text-center">出售价</th>
                                        <th  class="text-center">库存</th>
                                        <th  class="text-center">选择数量</th>
                                        <th  class="text-center">选择跟单</th>
                                    </tr>
                                    </thead>
                                    <tbody class="text-center" id="add-ok">
                                    {volist name='product' id='value'}
                                    <tr>
                                        <td>{$value.id}</td>
                                        <td>{$value.sn}</td>
                                        <td>{$value.name}</td>
                                        <td>{$value.unit}</td>
                                        <td>{$value.sell_price}</td>
                                        <td>{$value.inventory}</td>
                                        <td><input type="text" style="width: 50px; text-align: center" value="0" class="num"></td>
                                        <td  class="documentary" style="cursor:pointer"><span class="glyphicon glyphicon-ok"> 选择</span></td>
                                    </tr>
                                    {/volist}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <!-- 注脚 -->
                    </div>
                </div>
            </div>

            <!--list-->
            <div class="modal" tabindex="-1"  id="myModalss" data-backdrop="static" >
                <div class="modal-dialog">
                    <!-- 内容声明 -->
                    <div class="modal-content" style="width: 700px;">
                        <!-- 头部 -->
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">
                                <span>&times;</span>
                            </button>
                            <h4 class="modal-title"> <span class="glyphicon glyphicon-plus"> 订单信息详情</span>  </h4>
                        </div>
                        <!-- 主体 -->
                        <div class="modal-body" style="overflow: auto; height: 400px;">
                            <table class="table table-hover table-bordered text-center">
                                <tr>
                                    <th colspan="5" align="left"> 订单信息详情</th>
                                </tr>
                                <tr>
                                    <td width="15%">订单标题：</td>
                                    <td width="80%"  id="order_title"></td>
                                </tr>
                                <tr>
                                    <td>订单编号：</td>
                                    <td id="order_sn"></td>
                                </tr>
                                <tr>
                                    <td>所属公司：</td>
                                    <td id="order_client_company"></td>
                                </tr>
                                <tr>
                                    <td>跟单员：</td>
                                    <td id="order_staff_name"></td>
                                </tr>
                                <tr>
                                    <td>入订单原价：</td>
                                    <td id="order_cost"></td>
                                </tr>
                                <tr>
                                    <td>订单金额：</td>
                                    <td id="order_original"></td>
                                </tr>
                                <tr>
                                    <td>录入员：</td>
                                    <td id="order_enter"></td>
                                </tr>
                                <tr>
                                    <td>创建时间：</td>
                                    <td id="order_create_time"></td>
                                </tr>
                                <tr>
                                    <td>详情：</td>
                                    <td id="order_details"></td>
                                </tr>
                            </table>


                            <table class="table-bordered table">
                                <thead>
                                <tr >
                                    <th  class="text-center">产品编号</th>
                                    <th  class="text-center">产品名称</th>
                                    <th  class="text-center">销售价格</th>
                                    <th  class="text-center">出货量</th>
                                    <th  class="text-center">状态</th>
                                    <th  class="text-center">出货时间</th>
                                </tr>
                                </thead>
                                <tbody id="list_ok">

                                </tbody>
                            </table>

                        </div>
                        <!-- 注脚 -->
                        <div class="modal-footer">
                            <a  class="btn btn-danger" style="margin-top: -5px;" data-dismiss="modal" > <span class="glyphicon glyphicon-remove">关闭</span></a>
                        </div>
                    </div>
                </div>
            </div>



            <div id="DataTables_Table_0_wrapper" class="dataTables_wrapper form-inline" role="grid">
                <div class="row">
                    <div class="col-sm-6">
                        <div class="dataTables_length" id="DataTables_Table_0_length">
                            <a data-toggle="modal" data-target="#myModal"><span class="glyphicon glyphicon-plus"></span> 新增</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                             <a  href="" class="btn btn-warning  btn-sm "><i class="glyphicon glyphicon-refresh"></i>  重置 / 刷新</a>
                            <p></p>

                            <!--bootstrap-->

                            <div role="form" class=" form-group-sm" style="width: 1480px;">
                                <label>关键字：&nbsp;&nbsp;</label>
                                <div class="form-group">
                                    <label for="exampleInputEmail2" class="sr-only" ></label>
                                    <input type="text" placeholder="关键字" id="exampleInputEmail2" class="form-control" name="accounts" >
                                </div>

                                <div class="form-group">
                                    <div class="form-group" id="data_5">
                                        <div class="input-daterange input-group" id="datepicker">
                                            <input type="text" class="input-sm form-control" name="start" value="{:date('Y-m-d')}"  readonly  style="background: white" id="start" />
                                            <span class="input-group-addon">到</span>
                                            <input type="text" class="input-sm form-control" name="end" value="{:date('Y-m-d',time()+86400)}" style="background: white"  readonly  id="end" />
                                        </div>
                                    </div>
                                </div>
                                <button class="btn btn-white btn-sm" id="select" >查询</button>
                            </div>
                            <br>


                        </div>
                    </div>

                </div>
                <table class="table table-striped table-bordered table-hover dataTables-example dataTable" id="DataTables_Table_0" aria-describedby="DataTables_Table_0_info">

                    <thead >
                    <tr role="row">
                        <th class="sorting_asc_disabled" tabindex="0" aria-controls="DataTables_Table_0"  style="width: 30px;">
                            <div class="text-center">
                                <input type="checkbox" disabled >
                            </div>

                        </th>
                        <th class="sorting_asc_disabled text-center" tabindex="0" >订单编号</th>
                        <th class="sorting_asc_disabled text-center"  >订单标题</th>
                        <th class="sorting_asc_disabled text-center"  >所属名称</th>
                        <th class="sorting_asc_disabled text-center"  >订单金额</th>
                        <th class="sorting_asc_disabled text-center"  >跟单员</th>
                        <th class="sorting_asc_disabled text-center"  >付款状态</th>
                        <th class="sorting_asc_disabled text-center"  >录入员</th>
                        <th class="sorting_asc_disabled text-center"  >创建时间</th>
                        <th class="sorting_asc_disabled text-center"  >详情</th>
                    </thead>
                    <tbody id="ok-create">
                    {volist name='order' id='value'}
                    <tr class="gradeA odd {$value.id} select-remove">
                        <td class="sorting_1">
                            <div class="text-center">
                                <input type="checkbox" name="check[]"  yang="yang"  value="{$value.id}" >
                            </div>
                        </td>
                        <td class="text-center">{$value.sn}</td>
                        <td class="text-center">{$value.title}</td>
                        <td class="text-center">{$value.documentary.client_company}</td>
                        <td class="text-center">{$value.original}</td>
                        <td class="text-center">{$value.documentary.staff_name}</td>
                        <td class="text-center">{$value.pay_state}</td>
                        <td class="text-center">{$value.enter}</td>
                        <td class="text-center">{$value.create_time}</td>
                        <td class="text-center">
                            <a class="details"   details_id="{$value.id}"><i class="fa fa-file-text-o"></i>  </a>
                        </td>
                    </tr>
                    {/volist}
                </table>
                <div class="row">
                    <div class="col-sm-6">
                        <div class="text-right" id="page">
                            {$order->render()}
                        </div>
                    </div>

                </div>

            </div>
            <!--jquery 全选，不全选，反选...-->
            <script>

               // var array=[['100','12'],['200','13']];

                $(function() {  //prop和attr方法都是设置或者修改被选元素的属性，
                    // prop方法用于HTML元素本身就带有的固有属性，
                    // attr方法用于HTML元素自己定义的dom属性，

                    $("#checkedAll").click(function() {

                        if (this.checked) {

                            $("[yang=yang]:checkbox").prop("checked", true);
                        }else {

                            $("[yang=yang]:checkbox").prop("checked", false);
                        }
                    });

                    $("#checkboxAll").click(function() {

                        $("[yang=yang]:checkbox").prop("checked", true);
                    });

                    $("#checkedNo").click(function() {

                        $("[yang=yang]:checkbox").prop("checked", false);
                    });

                    $("#checkedRev").click(function() {

                        $("[yang=yang]:checkbox").each(function() {
                            console.log(this.checked);
                            this.checked = !this.checked//this指当前的html对象
                        });
                    });

                    $("#submit").click(function() {

                        var str = "你喜欢的是："
                        $("[yang=yang]:checkbox:checked").each(function() {

                            str += $(this).val() + "||";//这里$(this)指的是jquery对象
                        })

                        console.log(str);
                    });
                })



                $("#test").click(function () {
                    $("#myModal").modal('hide');
                    $("#product_name").modal('show');
                });

                $("#product_ok").on('click','.documentary',function () {

                    $("#client_company").val($(this).prev().prev().prev().html());
                    $("#client_company").attr('client_id',$(this).prev().prev().prev().prev().prev().html());

                    $("#client_company").attr('staff_name',$(this).prev().html());
                    $("#client_company").attr('client_company',$(this).prev().prev().html());


                   $("#product_name").modal('hide');
                   $("#myModal").modal('show');
                });


                //add
                $("#add").click(function () {
                    $("#myModal").modal('hide');
                    $("#product").modal('show');
                });


                $(".num").keyup(function () {
                     if (Number( $(this).val() ) >  Number( $(this).parent().prev().html())){
                         $(this).val($(this).parent().prev().html());
                    }
                })

                $("#product").on('click','.documentary',function () {
                    if ($(this).prev().children().val()==0){
                        alert('数量不得小于等于0')
                    }else {

                        var num1= $(this).prev().prev().html();
                        var num2= $(this).prev().children().val();
                        var num3= num1 - num2;
                        $(this).prev().prev().html(num3);
                        if (num3==0){
                            $(this).parent().remove()
                        }

                        var num4=num2 *  $(this).prev().prev().prev().html() ;
                        var num5= Number($("#q").html());

                        var num6=num5 + num4;
                        $("#q").html(num6)



                        $("#documentary_ok").append('<tr  class="documentary_class">\n' +
                            '                                        <td>'+ $(this).prev().prev().prev().prev().prev().prev().html() +'</td>\n' +
                            '                                        <td>'+ $(this).prev().prev().prev().prev().prev().html() +'</td>\n' +
                            '                                        <td>'+ $(this).prev().prev().prev().prev().html() +'</td>\n' +
                            '                                        <td>'+$(this).prev().prev().prev().html()+'</td>\n' +
                            '                                        <td documentary_id="'+$(this).prev().prev().prev().prev().prev().prev().prev().html() +'">'+ $(this).prev().children().val() +'</td>\n' +
                            '                                         \n' +
                            '                                         \n' +
                            '                                        <td  class="delete" style="cursor:pointer"><span class="glyphicon glyphicon-remove"></span></td>\n' +
                            '                                    </tr>');

                        $("#product").modal('hide');
                        $("#myModal").modal('show');
                    }

                });
                //delete
                $('#documentary_ok').on('click','.delete',function () {
                    $(this).parent().remove();
                    var num1=$(this).parent().children().next().next().next().html();
                    var num2=$(this).parent().children().next().next().next().next().html();
                    var num3=num1*num2;
                    var num4=$("#q").html();
                    var num5=num4-num3;
                    $("#q").html(num5);
                });


                //add

                $('#submit').click(function () {
                   // alert($("#documentary_ok  ").children(":eq(0)").children(":eq(4)").attr('documentary_id'));
                    var myarray = new Array();
                     for (var i=0; i<$("#documentary_ok ").children().length; i++){
                          myarray[i]=[$('#documentary_ok').children(':eq("'+ i +'")').children(":eq(4)").html(),$('#documentary_ok').children(':eq("'+ i +'")').children(":eq(4)").attr('documentary_id')];
                     }
                     myarray=JSON.stringify(myarray);

                    $.ajax({
                        type: 'POST',
                        url: 'order',
                        data: {
                             data:myarray,
                             title:$("#title").val(),
                             documentary_id:$('#client_company').attr('client_id'),
                             original:$("#x").val(),
                             details:$("#remarks").val(),
                             cost:$("#q").html(),
                        },
                        beforeSend:function(){
                            $('#ok').modal('show');
                            $('#myModal').modal('hide');
                        },
                        success:function (r,s,x) {
                            if (r > 0) {
                                $('#ok-img').attr('src', '/__IMG__/jump_success.png');
                                $('#ok-text').html('数据添加成功');

                                $('#ok-create').prepend('<tr class="gradeA odd '+ r +' select-remove">\n' +
                                    '                        <td class="sorting_1">\n' +
                                    '                            <div class="text-center">\n' +
                                    '                                <input type="checkbox" name="check[]"  yang="yang"  value=" '+ r +' " >\n' +
                                    '                            </div>\n' +
                                    '                        </td>\n' +
                                    '                        <td class="text-center">{:date("YmdHis")}</td>\n' +
                                    '                        <td class="text-center">'+$("#title").val()+'</td>\n' +
                                    '                        <td class="text-center">'+ $("#client_company").attr("client_company") +'</td>\n' +
                                    '                        <td class="text-center">'+$("#x").val()+'</td>\n' +
                                    '                        <td class="text-center">'+ $("#client_company").attr("staff_name")  +'</td>\n' +
                                    '                        <td class="text-center">未支付</td>\n' +
                                    '                        <td class="text-center">{:session("name")}</td>\n' +
                                    '                        <td class="text-center">{:date("Y-m-d H:i:s")}</td>\n' +
                                    '                        <td class="text-center">\n' +
                                    '                            <a class="details"   details_id="'+r+'"><i class="fa fa-file-text-o"></i>  </a>\n' +
                                    '                        </td>\n' +
                                    '                    </tr>');

                                setTimeout(function () {
                                    $('#ok').modal('hide');
                                    $('#ok-img').attr('src', '/__IMG__/loading.gif');
                                    $('#ok-text').html('数据交互中..,');
                                }, 1000)
                            }else {
                                $('#ok-img').attr('src','/__IMG__/jump_error.png');
                                $('#ok-text').html(response['msg']);
                                setTimeout(function () {
                                    $('#ok').modal('hide');
                                    $('#ok-img').attr('src','/__IMG__/loading.gif');
                                    $('#ok-text').html('数据交互中..,');
                                },1000)
                            }
                        }

                    });

                    });

                //list
               $("#ok-create").on('click','.details',function () {
                   $.ajax({
                       type:"POST",
                       url:'order/details',
                       data:{
                           id:$(this).attr('details_id'),
                       },
                       beforeSend:function(){
                           $('#ok').modal('show');
                       },
                       success:function (r,s,x) {
                           $('#list_ok').children().remove();
                           $('#myModalss').modal('show');
                           var data=r;
                           newData=r.split("@@");
                           json01=newData[0];
                           json02=newData[1];
                           var listArray= JSON.parse(json02);
                           //
                           // //list
                           $('#order_title').html(listArray['title']);
                           $('#order_sn').html(listArray['sn']);
                           $('#order_original').html(listArray['original']);
                           $('#order_cost').html(listArray['cost']);
                           $('#order_enter').html(listArray['enter']);
                           $("#order_create_time").html(listArray['create_time']);
                           $("#order_client_company").html(listArray['client_company']);
                           $("#order_staff_name").html(listArray['staff_name']);
                           $("#order_details").html(listArray['details']);

                           //table
                           var productArray=JSON.parse(json01);

                           for (var i=0; i<productArray.length; i++){
                               $("#list_ok").prepend('  <tr>\n' +
                                   '                                    <td class="text-center">'+ productArray[i]['sn'] +'</td>\n' +
                                   '                                    <td class="text-center">'+ productArray[i]['name'] +'</td>\n' +
                                   '                                    <td class="text-center">'+ productArray[i]['sell_price'] +'</td>\n' +
                                   '                                    <td class="text-center">'+ productArray[i]['number'] +'</td>\n' +
                                   '                                    <td class="text-center">'+productArray[i]['state']  +'</td>\n' +
                                   '                                    <td class="text-center">'+ productArray[i]['dispose_time'] +'</td>\n' +
                                   '                                </tr>')
                           }

                           $('#ok').modal('hide');
                       }
                 });
               });

               //delete

            </script>

            {include file='layout/footer'}